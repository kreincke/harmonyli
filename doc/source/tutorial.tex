% mycsrf cloak file
%
% (c) Karsten Reincke, Frankfurt a.M. 2010, 2011, ff.
%
% This file is licensed under the Creative Commons Attribution 3.0 Germany
% License (http://creativecommons.org/licenses/by/3.0/de/): 
% For details see teh file LICENSE in the top directory
%
% select the document class
% S.26: [ 10pt|11pt|12pt onecolumn|twocolumn oneside|twoside notitlepage|titlepage final|draft
%         leqno fleqn openbib a4paper|a5paper|b5paper|letterpaper|legalpaper|executivepaper openrigth ]
% S.25: { article|report|book|letter ... }
%
% oder koma-skript S.10 + 16
\documentclass[
  DIV=calc,
  BCOR=5mm,
  12pt,
  headings=small,
  oneside,
  abstract=true,
  toc=bib,
  xcolor=dvipsnames,
  openany,
  ngerman,english]{scrartcl}
  
%%% (1) general configurations %%%
\usepackage[utf8]{inputenc}

%%% (2) language specific configurations %%%
\usepackage[]{a4,babel}
\selectlanguage{english}

% package for improving the grey value and the line feed handling
\usepackage{microtype}

%language specific quoting signs
%default for language english is american style of quotes
%\usepackage[english=british]{csquotes}
\usepackage[english=american]{csquotes}

% jurabib configuration
\usepackage[see]{jurabib}
\bibliographystyle{jurabib}
\input{cfg/inc.jbib-cfg.tex}

% language specific hyphenation
\input{cfg/inc.hyphenations.tex}

%%% (3) layout page configuration %%%

% select the visible parts of a page
% S.31: { plain|empty|headings|myheadings }
%\pagestyle{myheadings}
\pagestyle{headings}

% select the wished style of page-numbering
% S.32: { arabic,roman,Roman,alph,Alph }
\pagenumbering{arabic}
\setcounter{page}{1}

% select the wished distances using the general setlength order:
% S.34 { baselineskip| parskip | parindent }
% - general no indent for paragraphs
\setlength{\parindent}{0pt}
\setlength{\parskip}{1.2ex plus 0.2ex minus 0.2ex}


%%% (4) general package activation %%%
%\usepackage{utopia}
%\usepackage{courier}
%\usepackage{avant}
\usepackage[dvips]{epsfig}

% graphic

\usepackage{array}
\usepackage{shadow}
\usepackage{fancybox}

\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
\usepackage{wasysym}

\usepackage{chngcntr}


%- start(footnote-configuration)

\deffootnote[1.5em]{1.5em}{1.5em}{\textsuperscript{\thefootnotemark)\ }}

% if document class = book: count footnotes from start to end
%\counterwithout{footnote}{chapter}
%- end(footnote-configuration)

% package for macking tables with broken lines
\usepackage{multirow}

%for using label as nameref
\usepackage{nameref}

%integrate nomenclature
\input{cfg/inc.ncl-meta.tex}

% depth of contents
\setcounter{secnumdepth}{5}
\setcounter{tocdepth}{5}

% Hyperlinks
\usepackage[breaklinks=true]{hyperref}
\hypersetup{bookmarks=true,breaklinks=true,colorlinks=true,citecolor=blue,draft=false}
\newcommand{\acc}[0]{\textit}
\newcommand{\ra}[0]{$\rightarrow$}
\newcommand{\lnka}[1]{\href{#1}{\texttt{#1}}}
\newcommand{\lnkb}[2]{\href{#1}{\texttt{#1} (RDL: #2)}}
\newcommand{\lnkr}[1]{\ra\ \href{#1}{\texttt{#1}}}


\usepackage{harmony}
\usepackage{musicography}

%\usepackage{bigfoot}
\usepackage{verbatimbox}

\newcommand{\hlyn}[0]{\textit{harmonyli.ly}}
\newcommand{\hlyf}[0]{\texttt{harmonyli.ly}}
\newcommand{\lily}[0]{\textit{LilyPond}}
\newcommand{\has}[1]{\textit{Harmony Analysis Symbol#1}}


\usepackage{longtable}


\begin{document}

%% use all entries of the bliography
\nocite{*}

%%-- start(titlepage)
\titlehead{Tutorial}
\subject{Release \input{inc.rel.tex}}
\title{harmonyli.ly}
\subtitle{Harmonical Analysis Symbols in LilyPond Scores}
\author{Karsten Reincke\input{cfg/inc.license-fn.tex}}

%thanks entry cannot be combined with license footnote
%\thanks{den Autoren von KOMA-Script und denen von Jurabib}

\maketitle
%%-- end(titlepage)

\footnotesize
\tableofcontents

\normalsize

\section{Introduction}

As so often - in the beginning there was a need: I had to write a musicological
work.

Actually, I had a good starting point: I knew, that there was an Anglo-American
scientific style which heavily differed from the European resp. German standard
in the humanities. To close that gap, I had already created a \LaTeX\
environment for writing scientific articles and books which even fulfilled the
very sophisticated requirements of the humanities in general and the standards
of the musicology in particular. I had documented that work, had explained and
justified that style of writing and published the result as open source
software.

Unfortunately, I did not know, how to embed snippets of musical scores into a
\LaTeX\ file. Trawling through the web delivered a bulk of tools and methods,
but no manual, how to do so, and no tutorial, how to successfully combine which
tools for getting a usable working environment. Therefore, I started an
investigation. And again, I published my work as a kind of open source
software.

A preliminary result of this investigation was, that we had three backends for
using musical notes in \LaTeX: We could use the style of \acc{ABC}-Notation and
would only be able to integrate very simple harmony analysis symbols into our
exemplifying score. Or we could use a combination of \acc{\LaTeX, Musix\TeX, and
harmony} which offered excellent and sophisticated results, but enforced us, to
use the very complex and difficult typesetting language \acc{MusicTeX} without
being supported by any good (semi-)graphical Editor. Or we could use the well
established coding environment \acc{LilyPond} and its \LaTeX-integration tool
\acc{lilypondbook} together with at least two excellent semi-graphical Editors
like \acc{Frescobaldi} or \acc{Elysium}. Moreover, if we were willing to use
converters like \acc{musicxml2ly}, we could also use the genuine graphic editor
\acc{MuseScore}. But then, we would again not be able to insert  harmony
analysis symbols on a level which matches the state of the art and which was
fulfilled by the \LaTeX\ tool \acc{harmony}.

At that point I knew, what was possible. But I did not want to respect the
result. Using \acc{\LaTeX, Musix\TeX, and harmony} would decrease my productivity
in an unacceptable manner. So, I started a reimplementation of \acc{harmony} for
\acc{LilyPond} by using its LISP based language \acc{GUILE} and the respectives
techniques for expanding this score edition system. I decided to name it
\acc{harmonyli.ly}, because this name would give credits to the \LaTeX\ based
idea generator \acc{harmony} as well as to the intended target system
\acc{LilyPond}, which I had learned to love. My result worked. But its
appearance was not on the level I preferred to achieve.

So, I asked the \acc{LilyPond} community for feedback. I knew, that at that time
I might have been a good programmer, an expert of musical theory, and an adept
of Free and Open Source Software and its spirit, but I certainly was not familiar
with the internals of \acc{LilyPond}, its 'biotope' of additional tools and its
history. From this point, a typical open source success-story started.

I got a lot of hints, for instance by \ldots. And I was told the \ldots had
already written a first version of such a tool and that it was published as
Public Domain Software in the \acc{LilyPond Snippet Repository}. So I took this
preliminary work, redesigned and expanded the interface, rewrote some functions
and added a lot of other code. But nevertheless, my work was a derivative work
of Hand Blum's work. So -- and even if it had not been necessary from a legal
point of view --, I asked him whether he could agree that I re-engineered his
work and that I released the result under a licensing construct, by which the
user could chose the license he prefered, either GPL or MIT. And to my great
pleasure, Hans Blum agreed with this concept. 

That was the way by which you now obtain three results, which should not be
undervalued:
\begin{itemize}
  \item With \hlyn, you get a technique to enrich your scores by
  harmony analysis symbols on a level, which is as expressive as it is required
  by the musicology and as beautiful as it necessary for not disturbing the
  excellent outpout of \acc{LilyPond}.
  \item You get \hlyn\ as open source software. And the act of licensing is
  explicitly approved by the copyright holders Hans Blum and me, Karsten
  Reincke. hence, you can be sure also to get the rights to use \hlyn.
  \item You get a complete tutorial which thoroughly explains 
  \begin{itemize}
    \item how to generally install and integrate \hlyn into your work
    \item how to prepare your work for using \hlyn successfuly
    \item how to create the particular \has{s} required by the musicology.
  \end{itemize}
\end{itemize}

And the way of learning how to use \hlyn\ starts now:

\section{Installation \& Integration}
\begin{itemize}
  \item Clone the \hlyn\ repository or download and extract the \hlyn\ zip
  archive by using the respective (github)
  commands.\footnote{\lnkr{https://github.com/kreincke/harmonyli.ly}}
  \item Copy the file \hlyf\ somewhere into your file system.
  \item Insert the command \texttt{\textbackslash include 
  "YOUR\_PATH\_TO/harmonyli.ly"} into
  your \lily\ file above the first \texttt{score\{\ldots\}} section.
  \item Expand your \texttt{layout\{\ldots\}} section by the line
   \texttt{\textbackslash context\{\textbackslash Lyrics \textbackslash consists
   "Text\_spanner\_engraver"\}}.
\end{itemize}

\section{Application \& Utilization}

\hlyn\ uses the lyrics technique of \lily\ to embed the \has{s} into the \lily\
score. The benefit is that \lily\ itself aligns the music notes and the
respective analysis symbols: it prevents horizontal overlappings, if a \has\ is
longer than the respective note.

As a little disadvantage \hlyn\ needs a dedicated voice to which the row of
\has{s} can be bound. After having set up your \lily\ file as described above
you have three opportunities to fulfill this condition:

\subsection{Binding \has{s} to a Real Voice}

Linking \has{s} to a really used staff is straight forward: 

\subsubsection{Example}
\begin{center}
\begin{lilypond}

\version "2.18.2"

\header { tagline = "" }
\include "lilypond/harmonyli.ly"
  
\score {
  \new StaffGroup {
    \time 4/4
    <<
      \new Staff {
        \relative d' {
          \clef "treble"
          \key d \major  
          \stemUp
          < fis a d>2 < fis a dis> < g b e> < g b eis>2 | 
          < fis b fis'>2 < b e gis> < a e' g!> < a d fis>2 \bar "||"
        }   
      }
      \new Staff {
        \relative d { 
          \clef "bass"
          \key d \major  
          \stemDown
          d2 b d cis  |
          d b d4 cis4 d2 \bar "||"
        }   
      }
      \addlyrics {
          \markup \setHas "T" #'(("C"."D")("fr" . " "))
          \markup \setImHas "D" #'(("B"."1")("a" . "7")("fr" . " "))
          \markup \setHas "Sp" #'(("B"."7")("a" . "7")("fl" . " ")("fr" . " "))
          \markup \setHas "D" #'(("T"."x")("B"."3")("a" . "5")("b" . "7")("c" . "♭9>♯8")("fr" . " "))
          \markup \setHas "Tp" #'(("B"."3")("fl" . " ")("fr" . " ")) 
          \markup \setHas "D" #'(("T"."d")("B"."5")("a" . "7")("b" . "8")("fr" . " ")) 
                 
          \initTextSpan "  "
          \markup \openZoomRow "D" #'(("a"."4")("fl" . " "))
          \startTextSpan
          \markup \expZoomRow #'(("a"."3")("fr" . " ")) 
          \stopTextSpan
  
          \markup \setHas "T" #'(("fr" . " "))
        }
    >>
  }
  \layout {
    \context {
      \Lyrics
      \consists "Text_spanner_engraver"
    }
  }
  \midi {}
}
\end{lilypond}
\end{center}

\subsubsection{Code}

\begin{scriptsize}
\begin{verbatim}
\version "2.18.2"
\header { tagline = "" }
\include "harmonyli.ly"
\score {
  \new StaffGroup {
    \time 4/4
    <<
      \new Staff {
        \relative d' {
          \clef "treble" \key d \major \stemUp
          < fis a d>2 < fis a dis> < g b e> < g b eis>2 | 
          < fis b fis'>2 < b e gis> < a e' g!> < a d fis>2 \bar "||"
      } }   

      \new Staff {
        \relative d { 
          \clef "bass" \key d \major \stemDown
          d2 b d cis  | d b d4 cis4 d2 \bar "||"
      } }   
      
      \addlyrics {
          \markup \setHas "T" #'(("C"."D")("fr" . " "))
          \markup \setImHas "D" #'(("B"."1")("a" . "7")("fr" . " "))
          \markup \setHas "Sp" #'(("B"."7")("a" . "7")("fl" . " ")("fr" . " "))
          \markup \setHas "D" #'(("T"."x")("B"."3")
                                ("a" . "5")("b" . "7")("c" . "-9>+8")("fr" . " "))
          \markup \setHas "Tp" #'(("B"."3")("fl" . " ")("fr" . " ")) 
          \markup \setHas "D" #'(("T"."d")("B"."5")("a" . "7")("b" . "8")
                                ("fr" . " "))    
          \initTextSpan "   "
          \markup \openZoomRow "D" #'(("a"."4")("fl" . " "))
          \startTextSpan
          \markup \expZoomRow #'(("a"."3")("fr" . " ")) 
          \stopTextSpan
          \markup \setHas "T" #'(("fr" . " "))
        }
    >>
  }
  \layout { \context{\Lyrics\consists "Text_spanner_engraver"} }
  \midi {}
}
\end{verbatim}
\end{scriptsize}

\subsubsection{Description}

This example contains a descant staff and a bass voice. To the letter one, it
appends the section \texttt{addlyrics}, which contains for each note of the bass
voice one specific \has. If you do not want to use such a 1:1 relation between
notes and \has{s}, you can use one of the other methods.

\subsection{Binding \has{s} to a Hidden Voice}

Linking the \has{s} to an invisible voice is a bit tricky: First, you must
design your staff as a staff with several voices. Then you inscribe a (mostly
very deep) 'artificial' voice into that staff and bind the symbols to that
'artificial' voice.\footnote{For demonstrating this option, we have colored the
'hidden' voice. If you change the string \texttt{new Voice = "AnalysisSubline"}
into \texttt{new NullVoice = "AnalysisSubline"}, the voice becomes really
invisble.}

This method is good for a score with a large amplitude of pitches (as some
romantic piano pieces use): by applying the method you can enforce a larger
distance between the used notes and the \has{s}.

\subsubsection{Example}
\begin{center}
\begin{lilypond}
\version "2.18.2"
\include "lilypond/harmonyli.ly"

\paper {
  indent = 0
  ragged-right = ##f
  system-system-spacing #'basic-distance = #20
  score-system-spacing =
    #'((basic-distance . 12)
       (minimum-distance . 6)
       (padding . 1)
       (stretchability . 12))
}

\header { tagline = "" }

global  = { \key d \major  \time 4/4}

descant = \relative c' {
  \clef treble \stemUp \global
  < fis a d>2 < fis a dis> < g b e> < g b eis>2 | 
  < fis b fis'>2 < b e gis> < a e' g!> < a d fis>2 \bar "||"
}

bass = \relative c {
  \clef bass \stemNeutral \global
  d2 b d cis  | d b d4 cis4 d2 \bar "||"
}

hasRhythmHidden =
\relative c, {
  \clef bass \stemDown \global
  \override NoteHead.color = #red
  \override NoteColumn #'ignore-collision = ##t
  c2 c | c c | c c | c4 c4 c2 \bar "||"
}

hasSymbols = \lyricmode {
  \override LyricText.self-alignment-X = #LEFT
  \override LyricExtender.left-padding = #-0.5
  \override LyricExtender.extra-offset = #'(0 . 0.5)

  \markup \setHas "T" #'(("C"."D")("fr" . " "))
  \markup \setImHas "D" #'(("B"."1")("a" . "7")("fr" . " "))
  \markup \setHas "Sp" #'(("B"."7")("a" . "7")("fl" . " ")("fr" . " "))
  \markup \setHas "D" #'(("T"."x")("B"."3")("a" . "5")("b" . "7")
                          ("c" . "♭9>♯8")("fr" . " "))
  \markup \setHas "Tp" #'(("B"."3")("fl" . " ")("fr" . " ")) 
  \markup \setHas "D" #'(("T"."d")("B"."5")("a" . "7")("b" . "8")
                          ("fr" . " "))    
  \initTextSpan "    "
  \markup \openZoomRow "D" #'(("a"."4")("fl" . " "))
  \startTextSpan
  \markup \expZoomRow #'(("a"."3")("fr" . " ")) 
  \stopTextSpan
  \markup \setHas "T" #'(("fr" . " "))
}

\score {
  <<
    \new GrandStaff <<
      \new Staff = upper
      \with { printPartCombineTexts = ##f }
      { <<
          \descant 
        >>
      }
      \new Staff = lower
      \new Voice = "Musical Bass"
      \with { printPartCombineTexts = ##f }
      { <<
          \bass
          % change "Voice" to "NullVoice" to make analyze voice unvisible:
          \new Voice = "AnalysisSubline" {\shiftOff  \hasRhythmHidden}
          \new Lyrics \lyricsto "AnalysisSubline" \hasSymbols
        >>
      }
    >>
  >>
  \layout{ \context { \Lyrics \consists "Text_spanner_engraver" } }
} 
\end{lilypond}
\end{center}

\subsubsection{Code}
\begin{scriptsize}
\begin{verbatim}
\version "2.18.2"
\include "lilypond/harmonyli.ly"

\paper {
  indent = 0
  ragged-right = ##f
  system-system-spacing #'basic-distance = #20
  score-system-spacing =
    #'((basic-distance . 12)
       (minimum-distance . 6)
       (padding . 1)
       (stretchability . 12))
}

\header { tagline = "" }

global  = { \key d \major  \time 4/4}

descant = \relative c' {
  \clef treble \stemUp \global
  < fis a d>2 < fis a dis> < g b e> < g b eis>2 | 
  < fis b fis'>2 < b e gis> < a e' g!> < a d fis>2 \bar "||"
}

bass = \relative c {
  \clef bass \stemNeutral \global
  d2 b d cis  | d b d4 cis4 d2 \bar "||"
}

hasRhythmHidden =
\relative c, {
  \clef bass \stemDown \global
  \override NoteHead.color = #red
  \override NoteColumn #'ignore-collision = ##t
  c2 c | c c | c c | c4 c4 c2 \bar "||"
}

hasSymbols = \lyricmode {
  \override LyricText.self-alignment-X = #LEFT
  \override LyricExtender.left-padding = #-0.5
  \override LyricExtender.extra-offset = #'(0 . 0.5)

  \markup \setHas "T" #'(("C"."D")("fr" . " "))
  \markup \setImHas "D" #'(("B"."1")("a" . "7")("fr" . " "))
  \markup \setHas "Sp" #'(("B"."7")("a" . "7")("fl" . " ")("fr" . " "))
  \markup \setHas "D" #'(("T"."x")("B"."3")("a" . "5")("b" . "7")
                          ("c" . "-9>+8")("fr" . " "))
  \markup \setHas "Tp" #'(("B"."3")("fl" . " ")("fr" . " ")) 
  \markup \setHas "D" #'(("T"."d")("B"."5")("a" . "7")("b" . "8")
                          ("fr" . " "))    
  \initTextSpan "    "
  \markup \openZoomRow "D" #'(("a"."4")("fl" . " "))
  \startTextSpan
  \markup \expZoomRow #'(("a"."3")("fr" . " ")) 
  \stopTextSpan
  \markup \setHas "T" #'(("fr" . " "))
}

\score {
  <<
    \new GrandStaff <<
      \new Staff = upper
      \with { printPartCombineTexts = ##f }
      { <<
          \descant 
        >>
      }
      \new Staff = lower
      \new Voice = "Musical Bass"
      \with { printPartCombineTexts = ##f }
      { <<
          \bass
          % change "Voice" to "NullVoice" to make analyze voice unvisible:
          \new Voice = "AnalysisSubline" {\shiftOff  \hasRhythmHidden}
          \new Lyrics \lyricsto "AnalysisSubline" \hasSymbols
        >>
      }
    >>
  >>
  \layout{ \context { \Lyrics \consists "Text_spanner_engraver" } }
} 
\end{verbatim}
\end{scriptsize}

\subsubsection{Description}

This example uses four voices in four variables: the right hand voice
(\texttt{= descant}), the left hand voice (\texttt{= bass)}, the hidden voice
defining the rhythmical granularity of the analysis (\texttt{= hasRhythmHidden})
and the respective stream of \has{s} (\texttt{= hasSymbols}). Inside of the
section \texttt{\textbackslash score{\ldots}} the 'sounding' bass and the
'virtual' voice \acc{AnalysisSubline} are inserted into the left hand staff. And
the stream of \has{s} \texttt{\textbackslash hasSymbols} is bound to that
'virtual' voice by using the command \texttt{\textbackslash lyristico} and a
reference by name.\footnote{Due to fact, that the \has{s} appear under the
analysis staff, it sometimes happens, that next part of your score (after the
system 'linefeed') is visually not sufficiently separated from the preceding
system. That agravates to read the score fluently. For increasing or decreasing
the distance between the system lines, you can play around with the values
inserted into the section \texttt{\textbackslash page\{\ldots\}}}


\subsection{Binding \has{s} to a Dedicated 'Analysis' Staff}

Binding the \has{s} to a specific \acc{analysis} staff is straight forward
again: you must create a voice in a special staff which only represents the
rhythm. 

This method is good for scores with many staves (like those of symphonies etc.):
it simplifies to ignore the harmonically irrelevant passing notes.

\subsubsection{Example}
\begin{center}
\begin{lilypond}

\version "2.18.2"
\include "lilypond/harmonyli.ly"

\paper {
  indent = 0
  ragged-right = ##f
  system-system-spacing #'basic-distance = #20
  score-system-spacing =
    #'((basic-distance . 12)
       (minimum-distance . 6)
       (padding . 1)
       (stretchability . 12))
}

\header { tagline = "" }

global  = { \key d \major  \time 4/4}

descant = \relative c' {
  \clef treble \stemUp \global
  < fis a d>2 < fis a dis> < g b e> < g b eis>2 | 
  < fis b fis'>2 < b e gis> < a e' g!> < a d fis>2 \bar "||"
}

bass = \relative c {
  \clef bass \stemNeutral \global
  d2 b d cis  | d b d4 cis4 d2 \bar "||"
}

hasRhythm = \relative c {
  \stemDown \global
  c2 c | c c | c c | c4 c4 c2 \bar "||"
}

hasSymbols = \lyricmode {
  \override LyricText.self-alignment-X = #LEFT
  \override LyricExtender.left-padding = #-0.5
  \override LyricExtender.extra-offset = #'(0 . 0.5)

  \markup \setHas "T" #'(("C"."D")("fr" . " "))
  \markup \setImHas "D" #'(("B"."1")("a" . "7")("fr" . " "))
  \markup \setHas "Sp" #'(("B"."7")("a" . "7")("fl" . " ")("fr" . " "))
  \markup \setHas "D" #'(("T"."x")("B"."3")("a" . "5")("b" . "7")
                          ("c" . "♭9>♯8")("fr" . " "))
  \markup \setHas "Tp" #'(("B"."3")("fl" . " ")("fr" . " ")) 
  \markup \setHas "D" #'(("T"."d")("B"."5")("a" . "7")("b" . "8")
                          ("fr" . " "))    
  \initTextSpan "    "
  \markup \openZoomRow "D" #'(("a"."4")("fl" . " "))
  \startTextSpan
  \markup \expZoomRow #'(("a"."3")("fr" . " ")) 
  \stopTextSpan
  \markup \setHas "T" #'(("fr" . " "))
}

\score {
  <<
    \new GrandStaff <<
      \new Staff = upper
      \with { printPartCombineTexts = ##f }{\descant}
      \new Staff = lower
      \with { printPartCombineTexts = ##f }{\bass}
    >>
    \new RhythmicStaff = analysis
    \with { printPartCombineTexts = ##f }
    {
      << 
      \new Voice = "AnalysisLine" { \hasRhythm}
      \new Lyrics \lyricsto "AnalysisLine" \hasSymbols
      >>
    }
  >>

  \layout{ \context{\Lyrics\consists "Text_spanner_engraver"}}
} 

\end{lilypond}
\end{center}


\subsubsection{Code}
\begin{scriptsize}
\begin{verbatim}
\version "2.18.2"
\include "lilypond/harmonyli.ly"

\paper {
  indent = 0
  ragged-right = ##f
  system-system-spacing #'basic-distance = #20
  score-system-spacing =
    #'((basic-distance . 12)
       (minimum-distance . 6)
       (padding . 1)
       (stretchability . 12))
}

\header { tagline = "" }

global  = { \key d \major  \time 4/4}

descant = \relative c' {
  \clef treble \stemUp \global
  < fis a d>2 < fis a dis> < g b e> < g b eis>2 | 
  < fis b fis'>2 < b e gis> < a e' g!> < a d fis>2 \bar "||"
}

bass = \relative c {
  \clef bass \stemNeutral \global
  d2 b d cis  | d b d4 cis4 d2 \bar "||"
}

hasRhythm = \relative c {
  \stemDown \global
  c2 c | c c | c c | c4 c4 c2 \bar "||"
}

hasSymbols = \lyricmode {
  \override LyricText.self-alignment-X = #LEFT
  \override LyricExtender.left-padding = #-0.5
  \override LyricExtender.extra-offset = #'(0 . 0.5)

  \markup \setHas "T" #'(("C"."D")("fr" . " "))
  \markup \setImHas "D" #'(("B"."1")("a" . "7")("fr" . " "))
  \markup \setHas "Sp" #'(("B"."7")("a" . "7")("fl" . " ")("fr" . " "))
  \markup \setHas "D" #'(("T"."x")("B"."3")("a" . "5")("b" . "7")
                          ("c" . "+9>-8")("fr" . " "))
  \markup \setHas "Tp" #'(("B"."3")("fl" . " ")("fr" . " ")) 
  \markup \setHas "D" #'(("T"."d")("B"."5")("a" . "7")("b" . "8")
                          ("fr" . " "))    
  \initTextSpan "    "
  \markup \openZoomRow "D" #'(("a"."4")("fl" . " "))
  \startTextSpan
  \markup \expZoomRow #'(("a"."3")("fr" . " ")) 
  \stopTextSpan
  \markup \setHas "T" #'(("fr" . " "))
}

\score {
  <<
    \new GrandStaff <<
      \new Staff = upper
      \with { printPartCombineTexts = ##f }{\descant}
      \new Staff = lower
      \with { printPartCombineTexts = ##f }{\bass}
    >>
    \new RhythmicStaff = analysis
    \with { printPartCombineTexts = ##f }
    {
      << 
      \new Voice = "AnalysisLine" { \hasRhythm}
      \new Lyrics \lyricsto "AnalysisLine" \hasSymbols
      >>
    }
  >>

  \layout{ \context{\Lyrics\consists "Text_spanner_engraver"}}
} 

\end{verbatim}
\end{scriptsize}

\subsubsection{Description}

In general, this third example follows the ideas of the second. But it does not
inscribe the sounding bass and the 'virtual' analysis voice into the same staff.
Instead of this, each of them gets its own staff. And again, the stream of
\has{s} is linked to the analysis voice \acc{hasRhythm} by the command
\texttt{\textbackslash lyristico} and a name reference.

\section{\has{s}}

After having generally explained how to integrate and use \hlyn, we can now
discuss, how particular \has{s}\ are generated by \hlyn\ commands. For that
purpose, \hlyn\ offers two interfaces: the basic \hlyn\ functions and some
often used instantiations. This chapter describes the general interface: 

\subsection{The basic \hlyn-functions}
The basic interface of \hlyn\ contains nine functions:

\begin{longtable}
  { r
    >{\raggedleft\hspace{0pt}}p{4cm}
    c
    >{\raggedright\hspace{0pt}}p{8cm}
   }
 
(01) & \textbf{setHas} & \ra & inserts a \has{}.
\tabularnewline
(02) & \textbf{setImHas} & \ra & inserts an \acc{Intermediary \has{}} whose
function refers to the root of the successing chord instead of being determined
by the keynote.
\tabularnewline
(03) & \textbf{setRfHas} & \ra & inserts a \acc{Reframing \has{}} as it is
required by modulations: the function of a chord -- determined by the current
tonal center -- is reinterpreted as a function in the context of the next tonal
center
\tabularnewline
(04) & \textbf{openImRow} & \ra & starts an intermediary chain of \has{s}\
where each chord of the chain refers to the root of chord which follows the chain
\tabularnewline
(05) & \textbf{closeImRow} & \ra & closes an intermediary chain of \has{s}\ 
and indicates, that the root of the directly successing chord is the tonal
center of that chain
\tabularnewline
(06) & \textbf{openZoomRow} & \ra & starts the zoom into a \has{} which shall 
cover suspended or passing notes
\tabularnewline
(07) & \textbf{expZoomRow} & \ra & expands an opened \has{} by a description of
suspended or passing notes which do not modify the current harmonical function
\tabularnewline
(08) & \textbf{openImZoomRow}  & \ra & starts the zoom into an intermediary
\has{} which shall cover suspended or passing notes
\tabularnewline
(09) & \textbf{closeImZoomRow} & \ra &  closes the zoom into a intermediary
\has{} which covers suspended or passing notes
\tabularnewline

\end{longtable}


\subsection{How to combine these \hlyn-functions correctly}

In accordance to the following eBNF
grammer\footnote{for details \ra\ 
\lnka{https://en.wikipedia.org/wiki/Extended\_Backus\%E2\%80\%93Naur\_form}
and/or \lnka{https://en.wikipedia.org/wiki/Backus-Naur\_form}
}, you can embed five types of subrows
into your stream of \has{s}\footnote{Note: \hlyn\ intends to be complete, but
not correct. This -- maybe surprising -- statement must be explained: In
computer sciences one discusses the correctness and the completeness of a
process for deriving syntagms by using a semantical interpretation of each
derivable syntagm. The construct (language and process) is \textbf{complete}, if
for any intended real world object a syntagm can be derived which refers to that
real world element. And the construct is \textbf{correct} if each derivable
syntagm refers to a real world object. For human beings in general and
musicologist in particular it is more important to use a \textbf{complete} 
language (of \has{s}) than using a correct language: We want to know that
we can express whatever we want to express, because our language is complete.
And we can avoid wrong / meaningless syntagms manually, so that the fact, that
our language is not correct (in the sense of computer languages) does not
matter. Therefore, we want to say that
\begin{itemize}
  \item \textbf{all} 'subrows' of \has{s} which are necessary to describe the
  harmonic relationships of real world chords must be formulatable by \hlyn.
  \item \textbf{not all} 'subrows' of \has{s} which can be generated by \hlyn\
  necessarily describe possible chord chains.
\end{itemize}
A last remark: If one had a correct and complete language for describing streams
of harmonical chords, then one would have a complete theory of harmonization
which no longer needs the help of 'unrepresented human knowledge'.
Delivering such a theory is far beyond the target of \hlyn.
}:

\begin{verbatim}
HasStream ::- ( setHas | setImHas | setRfHas |
                openImRow, setHas*, closeImRow |
                openZoomRow, expZoomRow+ |
                openImZoomRow, expZoomRow*, closeImZoomRow )+
\end{verbatim}

These production rules inidicate, that 
\begin{itemize}
  \item you may use the 'normal' \has{s}\ -- may it be a simple \has, an
  intermediary \has, or a reframing \has\ -- without having to consider its
  predecessors or successors
  \item you must close an opened intermediate row and between the opening and
  the closing element of that chain you can insert as many normal \has{s} as you
  want
  \item you need not explicitly to close an opened zoom
\end{itemize}


\subsection{The Syntax of a \has{}}

Typical \has{s}\ look like these:

\begin{center}
\begin{lilypond}

\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp
    < d' fis' a' d''>1 
    < b g' d'' e''>1 
    < cis' e' a' e''>1 
    < cis' g' b' e''>1 
    < d' gis' b' e''>1 
    < d' gis' b' e''>1 
    < cis' g' a' e''>1 
    < d' fis' a' d''>1 
  }
  \addlyrics { 
    \markup \setHas "T" #'()
    \markup \setHas "S" #'(("B"."3")("a"."5")("b"."6"))
    \markup \setHas "D" #'(("B"."3"))
    \markup \setHas "D" #'(("T"."x")("B"."3")("S"."5")("a"."7")("b"."9"))
    \markup \setHas "D" #'(("T"."d")("B"."7")("a"."7")("b"."8"))
    \markup \setImHas "D" #'(("B"."7")("a"."7")("b"."8"))
    \markup \setHas "D" #'(("B"."3")("a"."7")("b"."8"))
    \markup \setHas "T" #'()
  }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{lilypond}
\end{center}

They are created by different \hlyn\ functions, which -- nevertheless -- take
the same kind of parameters\footnote{except \texttt{setRfHas} and
\texttt{expZoomRow}}: The function symbol is obligatoric and specified as string
argument. The other parameters are optional and handed over in a list of
attributes. Let \hlyn\ itself visualize the structure of a \has{}:

\begin{center}
\begin{lilypond}
\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp 
   < fis' a' b' d'' e''>1 }
  \addlyrics { 
    \markup 
      \setHas "Functionsymbol" 
        #'( ("B"."B ::- Bassnote")
            ("S"."S ::- Soprannote")
            ("C"."C ::- Context")
            ("a"."a ::- first modifier")
            ("b"."b ::- second modifier")
            ("c"."c ::- third modifier")
            ("d"."d ::- fourth modifier")
            ("e"."e ::- fifth modifier")
            ("fl"."fl ::- präfix ")
            ("fr"." fr ::- suffix")
        ) }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{lilypond}
\end{center}

The general syntax to specify such a \has{}\ is this:

\begin{scriptsize}
\begin{verbatim}
...
  \addlyrics { 
    ...
    \setHas
      "T"             ; the function symbol
      #               ; indicator to read the following syntagm as scheme term
      `               ; indicator to evalute the syntagm and insert the result
      (               ; start of the syntagm 'attribute list'
        ("B" . "3")   ; insert a bass note 3
        ("S" . "8")   ; insert a sopran note 8
        ("C" ."D Major") ; explicate the keynote as reference
        ("a" . "3")   ; insert the lowest number beside the functional symbol
        ("b" . "5")   ; insert the second number beside the functional symbol
        ("c" . "6")   ; insert the third number beside the functional symbol
        ("d" . "8")   ; insert the fourth number beside the functional symbol
        ("e" . "9")   ; insert the fifth number beside the functional symbol
        ("fl" ."any-prefix ") ; insert a prefix before the harmony analysis symbol
        ("fr" ." any-suffix") ; insert a suffix after the harmony analysis symbol
      )               ; end of the attribute list
    ...
  }
\end{verbatim}
\end{scriptsize}

In general, you can skip the attributes which you do not want to use. And you
can insert the attributes you want to use in any succession you prefer.
Howsoever, the presented example would create the following output:

\begin{center}
\begin{lilypond}
\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp 
  < fis' a' b' d'' e''>1 }
  \addlyrics { 
    \markup 
      \setHas "T" 
        #'( ("B" . "3")   
            ("S" . "9")
            ("C" ."D Major")  
            ("a" . "3")   
            ("b" . "5")   
            ("c" . "6")  
            ("d" . "8")  
            ("e" . "9")  
            ("fl" ."any-prefix ") 
            ("fr" ." any-suffix") 
        ) }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{lilypond}
\end{center}

For modifying this example\footnote{Later, we will explicitly describe the
purpose of this feature 'explicating the context'. Up to that point we will
ignore this opportunity in our examples.} into an intermediary chord, you only
must replace the function \texttt{\textbackslash setHas} by the function
\texttt{\textbackslash setImHas}. As the result you will get this:

\begin{center}
\begin{lilypond}
\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp 
  < fis' a' b' d'' e''>1 }
  \addlyrics { 
    \markup 
      \setImHas "T" 
        #'( ("B" . "3")   
            ("S" . "9")   
            ("a" . "3")   
            ("b" . "5")   
            ("c" . "6")  
            ("d" . "8")  
            ("e" . "9")  
            ("fl" ."any-prefix ") 
            ("fr" ." any-suffix") 
        ) }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{lilypond}
\end{center}

If you want to cross out the functional symbol for indicating that the root is
not part of the chord or if you want to double the functional symbol for
indicating that it is a second level function or if you want to indicate both
aspects, simply add the attribute \verb|("T"."x")| respectively
\verb|("T"."d")| respectively \verb|("T"."dx")| or \verb|("T"."xd")|:

\begin{center}
\begin{lilypond}
\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key c \major \time 4/4 \stemUp 
  < fis' a' b' c'' e''>1 
  < fis' a' b' c'' e''>1 
  < fis' a' b' c'' e''>1 }
  \addlyrics { 
    \markup \setHas "D" 
        #'( ("T" . "x")("B" . "3")("S" . "9")   
            ("a" . "3")("b" . "5")("c" . "6")("d" . "7")("e" . "9")) 
    \markup \setHas "D" 
        #'( ("T" . "d")("B" . "3")("S" . "9")   
            ("a" . "3")("b" . "5")("c" . "6")("d" . "7")("e" . "9"))         
    \markup \setHas "D" 
        #'( ("T" . "xd")("B" . "3")("S" . "9")   
            ("a" . "3")("b" . "5")("c" . "6")("d" . "7")("e" . "9"))        
        }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{lilypond}
\end{center}

\section{\has{s}: Simple and Complex Examples}

After having explained the general methods to create a \has{}, we can now show
how one can fulfill specific musical needs by these techniques:

\subsection{Inserting a Function Symbol}

The majority of Anglo-Saxonian musicologists use something like the
'scale-step-theory' by which each tone of scale and the respective chord is
referred by the respective number (represented by a Roman numeral).
Alternatively one can use the functional (harmony) theory by which the chords of
a scale are referred by their harmonical functions (represented by
characters).\footcite[for dedails cf.][\nopage wp]{wpFunctionTheory2019a} Both
methods can be expressed by \hlyn: Insert the respective symbol as first
argument of the \hlyn\ basic functions. If you don't need any additional
specifier, add at least an empty attribution list \texttt{\#'()}:

\begin{center}
\begin{lilypond}

\version "2.18.2"

\header { tagline = "" }
\include "lilypond/harmonyli.ly"
  
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp
    < d' fis' a'>1 
    < e' g' b' >1  
    < fis' a' cis'' >1
    < g' b' d'' >1  
    < a' cis'' e'' >1 
    < b' d'' fis'' >1  
    < cis'' e'' g'' >1
  }
  \addlyrics {
    \markup \setHas "I" #'()
    \markup \setHas "II" #'()
    \markup \setHas "III" #'()
    \markup \setHas "IV" #'()
    \markup \setHas "V" #'()
    \markup \setHas "VI" #'()
    \markup \setHas "VII" #'()
  }
  \addlyrics {
    \markup \setHas "T" #'()
    \markup \setHas "Sp" #'()
    \markup \setHas "Tg/Dp" #'()
    \markup \setHas "S" #'()
    \markup \setHas "D" #'()
    \markup \setHas "Tp/Sg" #'()
    \markup \setHas "D" #'(("T"."x")("a" . "7"))
  }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}

\end{lilypond}
\end{center}
\begin{scriptsize}
\begin{verbatim}
\version "2.18.2"

\header { tagline = "" }
\include "lilypond/harmonyli.ly"
  
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp
    < d' fis' a'>1 
    < e' g' b' >1  
    < fis' a' cis'' >1
    < g' b' d'' >1  
    < a' cis'' e'' >1 
    < b' d'' fis'' >1  
    < cis'' e'' g'' >1
  }
  \addlyrics {
    \markup \setHas "I" #'()
    \markup \setHas "II" #'()
    \markup \setHas "III" #'()
    \markup \setHas "IV" #'()
    \markup \setHas "V" #'()
    \markup \setHas "VI" #'()
    \markup \setHas "VII" #'()
  }
  \addlyrics {
    \markup \setHas "T" #'()
    \markup \setHas "Sp" #'()
    \markup \setHas "Tg/Dp" #'()
    \markup \setHas "S" #'()
    \markup \setHas "D" #'()
    \markup \setHas "Tp/Sg" #'()
    \markup \setHas "D" #'(("T"."x")("a" . "7"))
  }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{verbatim}
\end{scriptsize}

\subsection{Indicating a Bass Note}

In the context of the scale-step-theory, the bass note is referred by the Roman
numeral which is inserted as a functional symbol. Hence, the  scale-step-theory
does not have the need to additionally indicate the bass note.

In the context of the functional harmony theory the chord is referred by its
function. By default the respective symbol implies that the root is the bass
note and that the chord uses the third and the fifth. Therefore, the bass note
of a described chord is only revealed if it is not the root of the chord. For
indicating the bass note expand the attribute list by the
string \texttt{("B"."YOUR\_NUMBER")}:

\begin{center}
\begin{lilypond}

\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp < fis' a' d'' a''>1 }
  \addlyrics { \markup \setHas "T" #'(("B"."3")) }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{lilypond}
\end{center}

\begin{scriptsize}
\begin{verbatim}
\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp < fis' a' d'' a''>1 }
  \addlyrics { 
\end{verbatim}
{ \color{red} \verb|    \markup \setHas "T" #'(("B"."3"))| }
\begin{verbatim}    
  }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{lilypond}
\end{center}
\end{verbatim}
\end{scriptsize}

\subsection{Indicating a Sopran Note}

Sometimes, a musicologist wants to explicitly specify the highest tone of a
chord. For indicating the 'soprano' note expand the attribute list by the string
\texttt{("S"."YOUR\_NUMBER")}:
\begin{center}
\begin{lilypond}

\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp < d' a' d'' fis''>1 }
  \addlyrics { \markup \setHas "T" #'(("S"."3")) }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{lilypond}
\end{center}

\begin{scriptsize}
\begin{verbatim}
\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp < fis' a' d'' a''>1 }
  \addlyrics { 
\end{verbatim}
{ \color{red} \verb|    \markup \setHas "T" #'(("S"."3"))| }
\begin{verbatim}    
  }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{lilypond}
\end{center}
\end{verbatim}
\end{scriptsize}

\subsection{Indicating Descant Tones}

In accordance to the method for writing a basso continuo, both theories
explicitly display the numbers of those chord tones which shall be used, but
which are not covered by the default rule 'take 1+3+5+8'. And with respect to
the other composition rule 'by default combine thirds' each number implictly
supresses its predecessor and successor. Hence, if the chord contains a second,
the two respective adjacent numbers must be revealed.

\hlyn\ allows you to add up to five deviating tones by inserting the strings
\texttt{("a"."YOUR\_NUMBER")}, \ldots, \texttt{("e"."YOUR\_NUMBER")} into the
attribute list. Additionally, these numbers can be altered by using the standard
UTF8 / unicode signs \{\musDoubleFlat , \musFlat , \musNatural , \musSharp ,
\musDoubleSharp \}\footnote{We use the \LaTeX\ command
 \texttt{\textbackslash verbatim} for showing the \lily\ code which creates the
 example. Unfortunately, we can not use special Unicode signs in these sections.
As a substitute we use \texttt{+} for \musSharp, \texttt{-} for \musFlat\ and 
 \texttt{*} for \musNatural. }:

\begin{center}
\begin{lilypond}

\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp 
    < a' c'' es'' f'' g'' bis''>1 
  }
  \addlyrics { 
    \markup \setHas "D" #'(("a"."3♮")("b"."5♭")("c"."6♮")("d"."7")("e"."9♯")) 
  }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{lilypond}
\end{center}

\begin{scriptsize}
\begin{verbatim}
\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp 
    < a' c'' es'' f'' g'' bis''>1 
  }
  \addlyrics {
  \end{verbatim}
  { \color{red} \verb|    \markup \setHas "D" #'(("a"."3*")("b"."5-")("c"."6*")("d"."7")("e"."9+")) |
  }
\begin{verbatim}    
  }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{verbatim}
\end{scriptsize}

Note, the 'scale-step-theory' and the 'functional harmony analysis' use
different types of numberings: In a \has{}, all numbers refer to the root of the
chord. In a description based on the scale-step-theory, all added numbers refer
the bass tone represented by the Roman numeral. Therefore, if we describe an
inversion of a chord, we have to use different numberings:

\begin{center}
\begin{lilypond}

\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp 
    < fis' a' d'' e''>1 
    < fis' a' d'' e''>1 
 }
  \addlyrics { 
    \markup \setHas "T" #'(("B"."3")("a"."8")("b"."9")) 
    \markup \setHas "III" #'(("a"."6")("b"."7")) 
  }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{lilypond}
\end{center}

\hlyn\ does not support you to use the correct digits. It is your task
to adequately describe the chords with respect to the chosen theory.

Sometimes it is helpful, to expand your representation by a reinterpretation in
accordance to an enharmonic change. The parameters 'a', \ldots,'e' can be bound
to strings, not only to (altered) numbers. So, you are able also to create
constructs like this:

\begin{center}
\begin{lilypond}

\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp 
    < fis' a' c'' es''>1 
 }
  \addlyrics { 
    \markup \setHas "T" #'(("B"."3")("a"."7♮")("b"."9♭⇒8♯")) 
  }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{lilypond}
\end{center}

\subsection{Indicating the Supression of the Root Tone}

In the context of the scale-step-theory, the bass note is referred by the Roman
numeral which is inserted as a functional symbol. And each tone of the chord is
described by the distance to that bass tone (= by the number of the respectiv
intervall). Hence, the scale-step-theory does not have the need to indicate the
supression of the root tone.

In the context of the functional harmony theory the chord is referred by its
function. By default the respective symbol implies that the root is the bass
note and that the chord uses the third and the fifth. But in some cases you want
to indicate, that the chord does not use its root, but only the other
explitcitly or implicitly specified tones.

For indicating that the chord does not contain its root, insert the string
\texttt{("T"."x")} into the attribute list:

\begin{center}
\begin{lilypond}

\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp < fis' a' fis'' a''>1 }
  \addlyrics { \markup \setHas "T" #'(("T"."x")) }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{lilypond}
\end{center}

\begin{scriptsize}
\begin{verbatim}
\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp < fis' a' fis'' a''>1 }
  \addlyrics { 
\end{verbatim}
{ \color{red} \verb|    \markup \setHas "T" #'(("T"."x"))| }
\begin{verbatim}    
  }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{lilypond}
\end{center}
\end{verbatim}
\end{scriptsize}

Note: Suppressing the root tone can be combined with the indication of a second
level function by adding the attribute \texttt{("T"."dx")} or
\texttt{("T"."xd")} into the attribute list.

\subsection{Indicating a Second Level Functions}

The functional harmony analysis also knows the second level function \acc{double
dominant}. \hlyn\ offers the opportunity to double all functional symbols for
creating any second level function symbol.

For indicating that the chord fulfills a second level function, insert the string
\texttt{("T"."d")} into the attribute list:

\begin{center}
\begin{lilypond}

\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp < e' gis' b'' e''>1 }
  \addlyrics { \markup \setHas "D" #'(("T"."d")) }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{lilypond}
\end{center}

\begin{scriptsize}
\begin{verbatim}
\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp < e' gis' h'' e''>1 }
  \addlyrics { 
\end{verbatim}
{ \color{red} \verb|    \markup \setHas "D" #'(("T"."d"))| }
\begin{verbatim}    
  }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{lilypond}
\end{center}
\end{verbatim}
\end{scriptsize}

Note: Suppressing the root tone can be combined with the indication of a second
level function by using the attribute \texttt{("T"."dx")} or
\texttt{("T"."xd")}.

\subsection{Indicating Intermediary Chords}

In the functional harmony theory, by default each function refers to the
keynote: In a \acc{D Major} piece, \acc{A Major} is taken as dominant. In an
\acc{E Major} piece, \acc{A Major} is taken as subdominant. But sometimes, the
musicologist must indicate that a chord has a function with respect to the root
of the succeeding chord instead of being determined by the keynote. Such chords
are know as intermediary chords.

For indicating that a single chord is an intermediary chord and that its function
refers to the root of its successors, use the function \texttt{\textbackslash
setImHas} instead of \texttt{\textbackslash setHas}:

\begin{center}
\begin{lilypond}

\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp 
    < e' gis' b' e''>1 < cis' a' e'' a''>1 }
  \addlyrics { 
    \markup \setImHas "D" #'() 
    \markup \setHas "D" #'(("B"."3")) }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{lilypond}
\end{center}

\begin{scriptsize}
\begin{verbatim}
\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp 
  < e' gis' b' e''>1 < cis' a' e'' a''>1  }
  \addlyrics { 
\end{verbatim}
{ \color{red} \verb|    \setImHas "D" #'() | }
\begin{verbatim}  
    \markup \setHas "D" #'(("B"."3")) }  
  }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{lilypond}
\end{center}
\end{verbatim}
\end{scriptsize} 
 
\subsection{Indicating the Chord Context}

The common use of intermediary chords leads attentive musicologists to the
conclusion, that the syntax of the functional harmony theory is still not
sufficiently designed. They know that their analyses sometimes unfortunately
depend on an underlying 'good will' understanding of their readers. Let us prove
this statement by a look at the following traditionally represented deceptive
cadence:

\begin{center}
\begin{lilypond}

\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp 
    < a' cis' e''>1 < fis' b' d'' >1 }
  \addlyrics { 
    \markup \setImHas "D" #'() 
    \markup \setHas "Tp" #'(("B"."5")) }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{lilypond}
\end{center}

The disadvantage of such a notation is, that the reader has to know, that A
major is the dominant of D major and the b minor is the relative key of D major
and that in this case therefore the row \texttt{(D) Tp} represents a deceptive
cadence. The representation of the harmonical analysis does not give him any
hint. But if we found the string \texttt{(D[T]) Tp}, which could indicate the
context of a chord, we would have a clear representation which would
syntactically indicate that the dominant to the tonic is followed by the
relative to the tonic and that therefore the definition of a deceptive cadence
is fulfilled:

\begin{center}
\begin{lilypond}

\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp 
    < a' cis' e''>1 < fis' b' d'' >1 }
  \addlyrics { 
    \markup \setImHas "D" #'(("C"."T")) 
    \markup \setHas "Tp" #'(("B"."5")) }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{lilypond}
\end{center}

If one uses such a representation for a deceptive cadence, then one can directly
argue from the definitions and the facts to the existence of a deceptive cadence:

\begin{itemize}
  \item Every dominant \texttt{D} leads to its tonic \texttt{T}.
  \item An intermediary chord \texttt{()} refers to the successor.
  \item In he current case, the successor is not the expected tonic, but the relative tonic.
  \item Hence it is not a cadence, but a deceptive cadence \texttt{(D) Tp}
\end{itemize}

For indicating the context of a specific function you must expand the attribute
list by the string \texttt{("C"."YOUR\_CONTEXT")}. The context can either be
another function or the root of a key.


\subsection{Indicating Intermediary Chains Chords}

Sometimes, the musicologist has not only to indicate a single intermediary
chord, but an intermediary chain of chords where each chord of this chain
refers to the successor of the chain. 

For deriving this need, let us first present an example and a traditional
straight forward analysis:

\begin{center}
\begin{lilypond}
\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp 
    \override Score.BarNumber.break-visibility = #'#(#t #t #t)
    < d' fis' a' d''>1 <  d' fis' a' c''>1  < e' g' b'> 
    < e' g' c'' g''>1 < d' a' c'' fis''>1 < b g' d'' g''>1 }
  \addlyrics { 
    \markup \setHas "T" #'((""."")) 
    \markup \setHas "T" #'(("a"."♮7")) 
    \markup \setHas "Sp" #'() 
    \markup \setHas "S" #'(("T"."d")("B"."3"))     
    \markup \setHas "T" #'(("a"."♮7"))
    \markup \setHas "S" #'(("B"."3"))
    }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{lilypond}
\end{center}

Beyond any doubt, this analysis is correct. But it is not appropriate because it
does not consider the leading quality of the decreased seventh in bar \texttt{2}
and bar \texttt{5}. An analysis which better covers our auditive understandings
would be this:

\begin{center}
\begin{lilypond}
\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp 
    \override Score.BarNumber.break-visibility = #'#(#t #t #t)
    < d' fis' a' d''>1 <  d' fis' a' c''>1  < e' g' b'> 
    < e' g' c'' g''>1 < d' a' c'' fis''>1 < b g' d'' g''>1 }
  \addlyrics { 
    \markup \setHas "T" #'((""."")) 
    \markup \setImHas "D[S]" #'(("a"."♮7")) 
    \markup \setHas "Sp" #'() 
    \markup \setHas "S" #'(("T"."d")("B"."3"))     
    \markup \setImHas "D" #'(("a"."♮7")) 
    \markup \setHas "S" #'(("B"."3"))
    }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{lilypond}
\end{center}

But even this analysis does not represent, what we hear. It does not capture the
functional releationshop of \texttt{e-minor} in bar \texttt{3} and
\texttt{C-Major} in bar \texttt{4} which is established by the three common
tones. So, a better interpretation would also represent the chords in bar
\texttt{3} and \texttt{4} with respect to the chord in  bar \texttt{6}:

\begin{center}
\begin{lilypond}
\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp 
    \override Score.BarNumber.break-visibility = #'#(#t #t #t)
    < d' fis' a' d''>1 <  d' fis' a' c''>1  < e' g' b'> 
    < e' g' c'' g''>1 < d' a' c'' fis''>1 < b g' d'' g''>1 }
  \addlyrics { 
    \markup \setHas "T" #'((""."")) 
    \markup \setImHas "D[S]" #'(("a"."♮7")) 
    \markup \setImHas "Sp[S]" #'() 
    \markup \setImHas "S[S]" #'(("B"."3"))     
    \markup \setImHas "D[S]" #'(("a"."♮7")) 
    \markup \setHas "S" #'(("B"."3"))
    }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{lilypond}
\end{center}

And here, we can directly see that all chords from bar \texttt{2} to bar
\texttt{5} functionally refer to the chord in bar \texttt{6}. Hence we hear an
intermediary chain of chords. \hlyn\ shall be able to represent such rows as it
is shown by the next interpretation:

\begin{center}
\begin{lilypond}
\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp 
    \override Score.BarNumber.break-visibility = #'#(#t #t #t)
    < d' fis' a' d''>1 | <  d' fis' a' c''>1 | < e' g' b'> |
    < e' g' c'' g''>1 | < d' a' c'' fis''>1 | < b g' d'' g''>1 |}
  \addlyrics { 
    \markup \setHas "T" #'((""."")) 
    \markup \openImRow "D" #'(("a"."♮7")) 
    \markup \setHas "Tp" #'() 
    \markup \setHas "S" #'(("B"."3"))     
    \markup \closeImRow "D" #'(("a"."♮7")) 
    \markup \setHas "S" #'(("B"."3"))
    }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{lilypond}
\end{center}

Here you can see the advantage of such a sophisticated analysis: only our last
interpretation syntactically represents the fact that we hear a deceptive
cadence in the row and that the complete chain of chords from bar \texttt{2} to
\texttt{6} as a unit fulfills the function of a subdomain.

Intermediary chains of chords can be created by explicitly open an intermediary
row, by inserting as many simple \has\ as necessary and by explicitly closing
the intermediary row as it is shown here:

\begin{scriptsize}
\begin{verbatim}
\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp 
    \override Score.BarNumber.break-visibility = #'#(#t #t #t)
    < d' fis' a' d''>1 | <  d' fis' a' c''>1 | < e' g' b'> |
    < e' g' c'' g''>1 | < d' a' c'' fis''>1 | < b g' d'' g''>1 |}
  \addlyrics { 
    \markup \setHas "T" #'((""."")) 
\end{verbatim}
{ \color{red} \verb|    \markup \openImRow "D" #'(("a"."-7")| }
\begin{verbatim} 
    \markup \setHas "Tp" #'() 
    \markup \setHas "S" #'(("B"."3"))     
\end{verbatim}
{ \color{red} \verb|    \markup closeImRow "D" #'(("a"."-7")| }
\begin{verbatim}  
    \markup \setHas "S" #'(("B"."3"))
    }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}

\end{verbatim}
\end{scriptsize}


Please keep in mind: It is not necessary that you agree with our analysis. But
we wanted to prove that \hlyn\ can grasp such complex relationships.

\subsection{Indicating the Context of Intermediary Chains of Chords}

But we must still tighten up the screw a bit more: If \hlyn\ shall be able to
represent deceptive candences by indicating the expected function of an
intermediary chord and the real disappointing function of the successing chord
-- as it is shown here --

\begin{center}
\begin{lilypond}
\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp 
    \override Score.BarNumber.break-visibility = #'#(#t #t #t)
    < d' fis' a' d''>1 | <  d' fis' a' c''>1 | < e' g' b'> |}
  \addlyrics { 
    \markup \setHas "T" #'((""."")) 
    \markup \setImHas "D" #'(("a"."♮7")("C"."S")) 
    \markup \setHas "Sp" #'() 
    }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{lilypond}
\end{center}

then \hlyn\  must also be able to represent deceptive cadences which use
intermediary chains of chords followed by a functionally disappointing relative
chord:

\begin{center}
\begin{lilypond}
\version "2.18.2"
\header { tagline = "" }
\include "lilypond/harmonyli.ly"
\score {
  \new Staff { \clef "treble" \key d \major \time 4/4 \stemUp 
    \override Score.BarNumber.break-visibility = #'#(#t #t #t)
    < d' fis' a' d''>1 | <  d' fis' a' c''>1 | < e' g' b'> |
    < e' g' c'' g''>1 | < d' a' c'' fis''>1 | < b g' e'' g''>1 |}
  \addlyrics { 
    \markup \setHas "T" #'((""."")) 
    \markup \openImRow "D" #'(("a"."♮7")) 
    \markup \setHas "Tp" #'() 
    \markup \setHas "S" #'(("B"."3"))     
    \markup \closeImRow "D" #'(("a"."♮7")("fr"."[S]")) 
    \markup \setHas "Sp" #'(("B"."5"))
    }
  \layout { \context { \Lyrics \consists "Text_spanner_engraver" } }
  \midi {}
}
\end{lilypond}
\end{center}


\subsection{Indicating Suspended and Passing Notes}

\subsection{Indicating Chords With Suspended and Passing Notes}

\subsection{Indicating Modulations}

\subsection{Indicating A Prefix or Suffix}

\subsection{The 'Often-Used' Interface of 'harmonyli.ly'}

\section{Package Content}














% insert the nomenclature here

\input{bib/ncl.abbreviations.tex}
%\input{bib/ncl.journals}
\printnomenclature

% insert the bibliographical data here
\bibliography{bib/literature}

\end{document}
